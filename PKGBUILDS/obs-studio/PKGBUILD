pkgname=obs-studio
pkgver='30.0.0'
pkgrel='3'
pkgdesc="Free, open source software for live streaming and recording"
arch=('x86_64')
url="https://obsproject.com"
license=('GPL2')
depends=('libva-mesa-driver' 'qt6-base' 'libfdk-aac' 'ffmpeg' 'jansson' 'cef-minimal-obs-bin' 'libxinerama' 'libxkbcommon-x11' 'mbedtls' 'rnnoise' 'pciutils' 'nss'
	'qt6-svg' 'qt6-wayland' 'xdg-desktop-portal' 'curl' 'jack' 'gtk-update-icon-cache' 'pipewire' 'libxcomposite')
makedepends=('cmake' 'libfdk-aac' 'x264' 'swig' 'python' 'luajit' 'sndio' 'git' 'nlohmann-json' 'websocketpp' 'asio')
provides=("obs-studio=$pkgver" "obs-websocket")
conflicts=("obs-studio" "obs-studio-tytan652" "obs-websocket")
optdepends=(
	'luajit: scripting support'
	'python: scripting support'
	'sndio: Sndio input client'
	'v4l2loopback-dkms: virtual camera support'
)
source=(obs-studio::git+https://github.com/obsproject/obs-studio.git#tag=30.0.0-rc2
	com.obsproject.Studio.desktop)
md5sums=('SKIP'
         'SKIP'
 )

prepare() {
	cd obs-studio
	git submodule update --init --recursive
}

build() {
	cd obs-studio
	mkdir -p build
	cd build

	cmake -DCMAKE_INSTALL_PREFIX="/usr" \
		-DUNIX_STRUCTURE=1 \
		-DENABLE_PIPEWIRE=ON \
		-DQT_VERSION=6 \
		-DENABLE_LIBFDK=ON \
		-DENABLE_SNDIO=ON \
		-DENABLE_RTMPS=ON \
		-DENABLE_VST=ON \
		-DENABLE_VLC=ON \
		-DENABLE_BROWSER=ON \
		-DCEF_ROOT_DIR="/opt/cef-obs/" \
		-DENABLE_AJA=OFF \
		-DENABLE_JACK=ON \
		-DENABLE_NEW_MPEGTS_OUTPUT=OFF \
		-DOBS_VERSION_OVERRIDE="30.0.0-beta3" ..

	make
}

package() {
	cd obs-studio/build
	make install DESTDIR="$pkgdir"

	cd ../..
	install -Dm0644 -t "$pkgdir/usr/share/applications/" "com.obsproject.Studio.desktop"
}
